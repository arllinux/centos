#==================================================
'Réglages initiaux après installation de CentOs 7'
#==================================================

1) Pour changer le nom d'hôte de façon permanente, éditez le fichier suivant :
# vim /etc/hostname
centos7_server

Après cela, éditez le fichier hosts :
# vim /etc/hosts
127.0.0.0.1 centos7_server localhost localhost.localdomain localhost4.localdomain4
Après le redémarrage, il affichera le nouveau nom d'hôte.

&======&

2) Après vous être loggé dans l'installation minimale du serveur CentOs7 vous constaterez que la commande ifconfig n'est pas présente :
# ifconfig

Il faut installer le paquet "net-tools" qui contient ifconfig :
# yum install net-tools

Essayez à nouveau la commande ifconfig :
# ifconfig

&======&

3) Changer le nom par defaut de la carte réseau par "eth0"
CentOs 7 propose par défaut des noms du type "enpS..", Pour changer ceci déplacer vous dans :
# vim /etc/default/grub
Cherchez la ligne "GRUB_CMDLINE_LINUX" et ajoutez à la fin :
net.ifnames=0 biosdevname=0

Créer une nouvelle configuration basée sur le système en cours d'exécution en utilisant la commande grub2-mkconfig :
# grub2-mkconfig -o /boot/grub2/grub.cfg

Renommer le fichier "ifcfg-enp2s0.." en "eth0"
# mv ifcfg-enp2s0 ifcfg-eth0

Si vous avez de carte réseau change le nom de la deuxième en "eth1"

Redemarrer
# reboot

Après le redémarrage vérifier que la modification a bien été prise en compte.
# ifconfig

&======&

4) Configurer l'adresse statique du serveur coté internet:

Editer le fichier : /etc/sysconfig/network-scripts/ifcfg-eth0
# vim /etc/sysconfig/network-scripts/ifcfg-eth0

Utiliser ces paramètres : à adapter en fonction du contexte
DEVICE="eth0"
ONBOOT=yes
BOOTPROTO=static
IPADDR=192.168.2.9
NETMASK=255.255.255.0
GATEWAY=192.168.2.1
# Ici le serveur qui est au dessus dans le réseau sert de seveur dns
DNS1=192.168.2.1

Arrêter et désactiver le "NetworkManager" parce que nous n'en avons pas besoin sur le serveur.
# systemctl stop NetworkManager 
# systemctl disable NetworkManager

Si l'on a déjà un serveur dhcp en amont, paramétrer celui-ci pour que l'adresse de notre serveur :
Ici : 192.168.2.9 soit une adresse dans la plage statique du serveur en amont

Relancer le service "network"
Attention, si vous vous connectez à distance, parce que vous serez déconnecté après l'émission de cette commande.
# systemctl restart network.service

Vérifiez que la nouvelle adresse est bien attribuée :
# ifconfig
inet 192.168.2.9

#############################################
# Configuration de la deuxième carte réseau #
# ###########################################

Configurer l'adresse statique du serveur coté reseau local :

Editer le fichier : /etc/sysconfig/network-scripts/ifcfg-eth1
# vim /etc/sysconfig/network-scripts/ifcfg-eth1

Utiliser ces paramètres : à adapter en fonction du contexte
DEVICE="eth1"
ONBOOT=yes
BOOTPROTO=static
IPADDR=192.168.3.1
NETMASK=255.255.255.0

# systemctl restart network.service
# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.2.9  netmask 255.255.255.0  broadcast 192.168.2.255
	inet6 fe80::224:1dff:fe13:85fe  prefixlen 64  scopeid 0x20<link>
        ether 00:24:1d:13:85:fe  txqueuelen 1000  (Ethernet)
	---/---
eth1: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 192.168.3.1  netmask 255.255.255.0  broadcast 192.168.3.255
        ether 00:21:27:c9:c5:85  txqueuelen 1000  (Ethernet)
	---/---
lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 0  (Boucle locale)
	---/---

&======&

5) Désactiver l'IPv6

Vérifier si l'IPv6 est activé ou non
# lsmod | grep -i ipv6

Si c'est le cas, éditer le fichier :
# vim /etc/default/grub
Cherchez la ligne "GRUB_CMDLINE_LINUX" et ajoutez au début :
ipv6.disable=1

Créer une nouvelle configuration basée sur le système en cours d'exécution en utilisant la commande grub2-mkconfig :
# grub2-mkconfig -o /boot/grub2/grub.cfg
Testez à nouveau si l'IPv6 est activé
# lsmod | grep -i ipv6

&======&

6) Ajouter le dépot EPEL
# cd /root
# mkdir RPMS
# cd RPMS
# rpm --import http://mirrors.nayatel.com/epel//RPM-GPG-KEY-EPEL-7
# rpm -Uvh http://mirrors.nayatel.com/epel/7/x86_64/e/epel-release-7-1.noarch.rpm

Lister les nouveaux dépots
# yum repolist

Régler les priorités des dépôts
Se déplacer dans le dossier : /etc/yum.repos.d
# /etc/yum.repos.d
# vim epel.repo

Supprimer la ligne :
protect = 1
Ajout de la ligne :
priority = 10
:wq

Ouvrir le fichier CentOS-Base.repo
# cd /etc/yum.repos.d
# vim Centos_Base.repo
Dans toutes les stances ajouter "enabled=0" au-dessous du titre.
Pour "base" - "update" - "extras" --> "enabled=1"
Pour les mêmes insérer une ligne et écrire : "priority=1"

Installer l'outils de gestion des priorités
# yum install yum-plugin-priorities

Un petit nettoyage :
# yum clean all
puis
# yum check-update
Pour vérifier que les modifications ont bien été prises en compte.
Et enfin si vous voulez mettre à jour tout le système :
# yum update

&======&

7) Activer les services iptables (au lieu de firewalld) :

Désactiver Firewalld
# systemctl stop firewalld
# systemctl disable firewalld

Lorsque vous essayer de démarrer / redémarrer iptables sur le serveur nouvellement installé, vous obtiendrais cette erreur:
# systemctl restart iptables.service
Redirecting to /bin/systemctl restart iptables.service
Failed to issues method call: Unit iptables.service failed to load: No such file or directory.

Pour corriger cette erreur, installez le paquet iptables-services :
# yum install iptables-services

Relancer la commande précédante :
# systemctl restart iptables.service

Mettre en place les règles du parefeu
Dans le dossier scripts il faut éxécuter, (après avoir adapté les règles)
le script : (consulter le fichier README_FIREWALL dans le répertoire)
# ./install_firewall.sh

&======&

8) Installer ntp (Network Time Protocol)
# yum install ntp

Le Protocole d'Heure Réseau (Network Time Protocol ou NTP) est un protocole qui permet de synchroniser,
via un réseau informatique, l'horloge locale d'ordinateurs sur une référence d'heure

Il faut ouvrir le port 123 en UDP dans le parefeu
# cd /usr/local/sbin/
# vim firewall.sh
Décommenter la ligne correspondant au port 123
Intéger la nouvelle règle de manière permanente au parefeu :
# ./firewall.sh
iptables: Saving firewall rules to /etc/sysconfig/iptables:[  OK  ]

Arrêter le service
# service ntp stop

Ajustement initial
# ntpdate fr.pool.ntp.org
21 Dec 00:28:15 ntpdate[4299]: adjust time server 37.59.60.67 offset -0.000431 sec

Créer le fichier journal :
# touch /var/log/ntp.log
# chown ntp:ntp /var/log/ntp.log

Paramétrer le fichier de configuration (/etc/ntp.conf)
---/---
driftfile /var/lib/ntp/ntp.drift
logfile /var/log/ntp.log
server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst
server 127.127.0.0
fudge 127.127.O.0 stratum 10
restrict default nomodify notrap nopeer noquery
restrict 127.0.0.1 mask 255.0.0.0

# service ntp start

Afficher la liste des serveurs
# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
+regar42.fr      62.210.16.53     3 u    2   64    1   51.360    0.887   1.206
*dalek.roflcopte 195.83.222.27    2 u    1   64    1   51.197   -0.569   0.003
+host1.thefox.co 188.165.255.179  3 u    2   64    1   71.746   -2.752   0.000
+www.mindstudios 145.238.203.14   2 u    1   64    1   50.894    0.012   0.000
 LOCAL(0)        .LOCL.          10 l    -   64    0    0.000    0.000   0.000

&===End===&
